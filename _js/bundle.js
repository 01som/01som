class App{constructor(params={}){this.paths=params.paths||App.defaults.paths.all(),this.spatial=params.spatial||!1,this.debug=params.debug||!1,this.container=params.svg||"#svg",this.pointRadius=params.pointRadius||24,this.paddingFactor=params.paddingFactor||2,this.buttons=params.buttons||App.defaults.buttons,this.padding=params.padding||this.paddingFactor*this.pointRadius,this.panner=null,this.vmax=0,this.vmin=0,this.circles=[],this.audios={},this.touched=!1,this.bpm=params.bpm||60,this.playing=!1,this.recording=!1,this.init()}get recording(){return this._recording}get playing(){return this._playing}get bpm(){return this._bpm}set playing(bool){this._playing=bool,bool?($("#btnPlay").removeClass("fa-play-circle"),$("#btnPlay").addClass("fa-stop-circle"),$("#spanPlay").text("STOP"),this.circles.forEach(function(circle){circle.schedule()}),Tone.Transport.start()):($("#btnPlay").removeClass("fa-stop-circle"),$("#btnPlay").addClass("fa-play-circle"),$("#spanPlay").text("PLAY"),this.circles&&this.circles.forEach(circle=>circle.stop()),Tone.Transport.stop())}set bpm(bpm){this._bpm=bpm;let{bg:bg}=this.buttons.find(button=>button.bpm===bpm);$("html").css("background-color",`rgb(255,${bg},${bg}`),$("#bpms button").removeClass("active"),$(`:button[value='${bpm}']`).addClass("active"),Tone.Transport.bpm.value=bpm}set recording(bool){bool?(this.recorder.record(),$("#btnRecord").css("color","red"),this.playing||(this.playing=!0)):this.recording&&($("#btnRecord").css("color","black"),this.recorder.stop(),this.recorder.exportWAV(blob=>{saveAs(blob,"Gravacao 0+1=SOM.wav")}),this.playing=!1),this._recording=bool}init(){this.initCanvas(),this.initAudio(),this.initButtons(),this.initHelp(),this.debug&&this.initDebug(),$(".fullscreen").click(()=>{screenfull.request()}),this.resize()}initDebug(){this.grid={};["vline","hline"].forEach(line=>{this.grid[line]=this.paper.line().attr({stroke:"rgba(0,0,0,0.3)"})}),this.margins={};["top","bottom","left","right","vmiddle","hmiddle"].forEach(margin=>{this.margins[margin]=this.paper.rect().attr({fill:"rgba(0,0,0,0.3)"})})}initCanvas(){this.paper=Snap(),$("svg").appendTo(this.container).addClass("content centered"),window.addEventListener("resize",()=>this.resize())}initAudio(){Tone.Transport.loopEnd="1m",Tone.Transport.loop=!0,StartAudioContext(Tone.context,"#btnPlay"),this.spatial&&(this.panner=(new Tone.Panner3D).connect(Tone.Master),Tone.Listener.setPosition(this.width/2,0,this.height/2)),this.recorder=new Recorder(Tone.Master.input)}initButtons(){new Vue({el:"#bpms",data:{buttons:this.buttons},methods:{click:bpm=>{this.bpm=bpm}}});$("#btnPlay").click(()=>{this.playing=!this.playing}),$("#btnRecord").click(()=>{this.recording=!this.recording})}initHelp(){Help.init()}resize(){this.width=$(this.container).width(),this.height=$(this.container).height(),this.vmax=Math.max(this.width,this.height),this.vmin=Math.min(this.width,this.height),this.circles&&this.circles.forEach(circle=>circle.resize()),this.debug&&this.debug()}addCircle(params){this.resize(),this.circles.push(new Circle(params,this)),this.loadSounds(this.paths)}loadSounds(paths){for(const key in paths)if(!(key in this.audios)){const player=new Tone.Player(this.paths[key]);this.audios[key]=player,this.spatial?player.connect(this.panner):player.connect(Tone.Master)}}debug(){this.grid&&(this.grid.vline.attr({x1:this.width/2,x2:this.width/2,y1:0,y2:this.height}),this.grid.hline.attr({x1:0,x2:this.width,y1:this.height/2,y2:this.height/2}),this.padding&&(this.margins.top.attr({x:0,y:0,width:this.width,height:this.padding}),this.margins.bottom.attr({x:0,y:this.height-this.padding,width:this.width,height:this.padding}),this.margins.hmiddle.attr({x:0,y:this.height/2-this.padding/2,width:this.width,height:this.padding}),this.margins.vmiddle.attr({x:this.width/2-this.padding/2,y:0,width:this.padding,height:this.height}),this.margins.left.attr({x:0,y:0,width:this.padding,height:this.height}),this.margins.right.attr({x:this.width-this.padding,y:0,width:this.padding,height:this.height})))}}const basePath="../_assets/sounds";App.defaults={buttons:[{bpm:44,bg:250},{bpm:52,bg:247},{bpm:60,bg:244},{bpm:80,bg:241},{bpm:100,bg:238},{bpm:120,bg:235}],paths:{percussive:{kick:`${basePath}/kick.mp3`,clap:`${basePath}/clap.mp3`,snap:`${basePath}/snap.mp3`},notes:{kick:`${basePath}/kick.mp3`,clap:`${basePath}/clap.mp3`,snap:`${basePath}/snap.mp3`,do1:`${basePath}/do1.mp3`,re:`${basePath}/re.mp3`,mi:`${basePath}/mi.mp3`,sol:`${basePath}/sol.mp3`,la:`${basePath}/la.mp3`,do2:`${basePath}/do2.mp3`},all(){return _.merge(this.percussive,this.notes)}}};class Circle{constructor(params={},app){if(this.app=app,this.params=params,this.n=params.n||8,this.options=params.options||[],this.shake=params.shake||!1,this.sequencer=params.sequencer||!1,this.binary=void 0!==params.binary,this.binaryMatrix=[],this.binary&&(this.binaryContainer=document.getElementById(params.binary),null===this.binaryContainer))throw new ReferenceError("Invalid div for binary");this.xFunc=params.xFunc||function(){return window.innerWidth/2},this.yFunc=params.yFunc||function(){return window.innerHeight/2},this.rFunc=params.rFunc||Circle.defaults.rFunc,this.pointRadius=params.pointRadius||app.pointRadius||24,this.dotRadius=params.dotRadius||2,this.sequencerRectSize=params.sequencerRectSize||40,this.pointFillColor=params.pointFillColor||Colors.white,this.pointStroke=params.pointStroke||Colors.grey,this.pointStrokeWidth=params.pointStrokeWidth||1,this.pointStrokeWidthHover=params.pointStrokeWidthHover||2,this.circleBackgroundColor=params.circleBackgroundColor||Colors.lightblue,this.dots=[],this.points=[],this.elem=null,this.groups=[],this.r=this.rFunc(),this.x=this.xFunc(),this.y=this.yFunc(),this.svg=this.app.paper.svg({x:this.x,y:this.y}),this.svg.attr({overflow:"visible"}),this.init()}init(){this.initCircle(),this.initDots(),this.sequencer?this.initSequencer():this.initPoints(),this.binary&&this.initBinary(),this.shake&&this.initShake(),this.app.debug&&this.initDebug()}initSequencer(){this.sequencer={},this.sequencer.active=this.params.sequencer.active||0,this.sequencer.labelsArray=this.params.sequencer.labels||["1","2","3"],this.sequencer.n=this.sequencer.labelsArray.length,this.initSequencerPoints(),this.initSequencerText()}initSequencerPoints(){this.sequencer.points=[],this.groups.points=this.svg.group(),this.groups.points.addClass("point");for(let i=0;i<this.sequencer.n;i++){this.sequencer.points[i]=[];for(let j=0;j<this.n;j++){let p=new Point(j,this);p.visible=i===this.sequencer.active,this.sequencer.points[i].push(p),this.groups.points.add(p.group)}}this.points=this.sequencer.points[this.sequencer.active]}initSequencerText(){this.sequencer.labels=[],this.groups.sequencer=this.svg.group(),this.groups.sequencer.addClass("sequencer");for(let j=0;j<this.sequencer.n;j++){const text=this.svg.text();text.attr({text:this.sequencer.labelsArray[j],fill:Colors.grey,id:`text-sequence-${j}`,"text-anchor":"middle","alignment-baseline":"central"});let rect=this.svg.rect(),stroke=j===this.sequencer.active?Colors.grey:this.circleBackgroundColor;rect.attr({fill:this.circleBackgroundColor,stroke:stroke,strokeWidth:1,id:`rect-sequence-${j}`});let group=this.svg.group(rect,text);group.addClass("label"),group.click(e=>{let prevLabelIdx=this.sequencer.active,currLabelIdx=Number(e.target.id.split("-")[2]);if(prevLabelIdx!==currLabelIdx){this.sequencer.active=currLabelIdx,this.sequencer.labels[prevLabelIdx].rect.attr({stroke:this.circleBackgroundColor}),this.sequencer.labels[currLabelIdx].rect.attr({stroke:grey}),this.points=this.sequencer.points[currLabelIdx];for(let i=0;i<this.sequencer.points.length;i++)this.sequencerPoints[i].forEach(p=>p.show(i===currLabelIdx));this.binary&&(this.binary=this.sequencer.binary[this.sequencer.active],this.updateBinary())}}),this.sequencer.labels.push({text:text,rect:rect,group:group}),this.alignSequencer(),this.groups.sequencer.add(group)}}initPoints(){this.groups.points=this.svg.group(),this.groups.points.addClass("point");for(let i=0;i<this.n;i++)this.points[i]=new Point(i,this),this.groups.points.add(this.points[i].group)}initBinary(){if(this.binaryContainer=document.getElementById(this.params.binary),null===this.binaryContainer)throw new ReferenceError("Invalid div for binary");if(this.sequencer){this.sequencer.binary=new Array(this.sequencer.n);for(let n=0;n<this.sequencer.n;n++)this.sequencer.binary[n]=Utils.zeros(this.options.length,this.points.length);this.binary=this.sequencer.binary[this.sequencer.active]}else this.binary=Utils.zeros(this.options.length,this.points.length);this.updateBinary()}initShake(){new Shake({threshold:15,timeout:1e3}).start();window.addEventListener("shake",()=>{this.app.playing&&(this.app.playing=!1),this.sequencer?this.sequencer.points.forEach(points=>points.forEach(point=>point.reset())):this.points.forEach(point=>point.reset())},!1)}initCircle(){this.elem=this.svg.circle(0,0,this.r),this.elem.attr({fill:this.circleBackgroundColor,stroke:Colors.grey,strokeWidth:3})}initDots(){this.groups.dots=this.svg.group(),this.groups.dots.addClass("dots");for(let i=0;i<this.n;i++){let angle=i/this.n*2*Math.PI,x=Math.sin(angle)*(this.r+this.pointRadius)*1.1,y=-Math.cos(angle)*(this.r+this.pointRadius)*1.1,dot=this.svg.circle(x,y,this.dotRadius).attr({visibility:"hidden"});this.dots.push(dot),this.groups.dots.add(dot)}}initDebug(){this.grid={};["vline","hline"].forEach(line=>{this.grid[line]=this.svg.line().attr({stroke:"rgba(0,0,0,0.3)"})}),this.resize()}resize(){this.x=this.xFunc(),this.y=this.yFunc();let ratio=this.rFunc()/this.r,transform=(new Snap.Matrix).scale(ratio);this.elem&&(this.svg.attr({x:this.x,y:this.y}),this.elem.transform(transform)),!this.sequencer&&this.points&&this.points.forEach(point=>{point.group.transform(transform),point.elem.attr({r:1*point.r/ratio})}),this.sequencer&&this.sequencer.points.forEach(sequencerPoints=>{sequencerPoints.forEach(point=>{point.group.transform(transform),point.elem.attr({r:1*point.r/ratio})})}),this.dots&&this.dots.forEach(function(dot){dot.transform(transform)}),this.sequencer&&this.alignSequencer(),this.app.debug&&this.grid&&(this.grid.vline.attr({x1:0,x2:0,y1:-this.svg.getBBox().h/2,y2:this.svg.getBBox().h/2}),this.grid.hline.attr({x1:-this.svg.getBBox().w/2,x2:this.svg.getBBox().w/2,y1:0,y2:0}))}schedule(){for(let i=0;i<this.n;i++)Tone.Transport.schedule(t=>{let p=this.points[i],previousI=0===i?this.n-1:i-1;if(p.elem.animate({r:1.25*this.pointRadius},150,function(){},p.elem.animate({r:this.pointRadius},1e3)),this.panner&&this.app.panner.setPosition(-p.x,0,p.y),Utils.hide(this.dots[previousI]),Utils.show(this.dots[i]),-1!==p.state){let{sample:sample}=this.options[p.state];this.app.audios[sample].start(t)}},`${i}*8n`)}stop(){this.dots.forEach(dot=>Utils.hide(dot))}updateBinary(){for(let i=0;i<this.binary.length;i++)for(let j=0;j<this.binary[i].length;j++)this.binary[i][j]=0;if(this.points.forEach((point,idx)=>{if(-1===point.state)return;let j=idx,i=point.state;this.binary[i][j]=1}),this.binary){this.binaryContainer.innerHTML="";for(let i=0;i<this.binary.length;i++){for(let j=0;j<this.binary[i].length;j++)this.binaryContainer.innerHTML+=this.binary[i][j];this.binaryContainer.innerHTML+="<br>"}}}alignSequencer(){this.sequencer.labels.forEach((label,index)=>{let step=2*this.rFunc()/(this.sequencer.n+1),x=-this.rFunc()+step+step*index;window.label=label,label.text.attr({x:x});const size=this.sequencerRectSize;label.rect.attr({x:x-size/2,y:-size/2,width:size,height:size})})}}Circle.defaults={},Circle.defaults.rFunc=function(){let r=(this.app.vmax/2-this.app.padding-this.app.padding/2-2*this.app.pointRadius)/2;return 2*r+2*this.app.pointRadius+2*this.app.padding>this.app.vmin&&(r=(this.app.vmin-2*this.app.padding-2*this.app.pointRadius)/2),r},Circle.defaults.xYFuncAux=function(app,offset=0){const pa=app.padding,pr=app.pointRadius;return offset+pa+pr+(app.vmax/2-pa-pa/2-2*pr)/2},Circle.defaults.xFunc1=function(){return Utils.isLandscape()?Circle.defaults.xYFuncAux(this.app):this.app.width/2},Circle.defaults.yFunc1=function(){return Utils.isPortrait()?Circle.defaults.xYFuncAux(this.app):this.app.height/2},Circle.defaults.xFunc2=function(){return Utils.isLandscape()?Circle.defaults.xYFuncAux(this.app,this.app.width/2-this.app.padding/2):this.app.width/2},Circle.defaults.yFunc2=function(){return Utils.isPortrait()?Circle.defaults.xYFuncAux(this.app,this.app.height/2-this.app.padding/2):this.app.height/2},Circle.defaults.options={percussive:[{color:Colors.blue,sample:"kick"},{color:Colors.green,sample:"clap"},{color:Colors.red,sample:"snap"}],notes:[{color:Colors.do1,sample:"do1",text:"DÓ"},{color:Colors.re,sample:"re",text:"RÉ"},{color:Colors.mi,sample:"mi",text:"MI"},{color:Colors.sol,sample:"sol",text:"SOL"},{color:Colors.la,sample:"la",text:"LÁ"},{color:Colors.do2,sample:"do2",text:"dó"}]};const Colors={black:"rgb(0,0,0)",blue:"rgb(30, 30, 225)",green:"rgb(30, 225, 30)",grey:"rgb(127,127,127)",lightblue:"rgb(220, 240, 255)",lightgreen:"rgb(220,255,240)",red:"rgb(225, 30, 30)",white:"rgb(255, 255, 255)",do1:"rgb(218, 165, 32)",re:"rgb(230, 230, 250)",mi:"rgb(170, 250, 172)",sol:"rgb(222, 129, 192)",la:"rgb(132, 170, 233)",do2:"rgb(255,248,220)"};class Help{static init(){$(".close-button").click(()=>this.show(!1)),$(".help-icon").click(()=>this.show(!0)),$(".modal").click(()=>this.show(!1)),Cookies.get("visited")||(Cookies.set("visited",!0,{expires:365,path:"/"}),this.show()),$(document).keyup(e=>{27===e.keyCode&&this.hide()})}static setVisible(bool){bool?($(".modal").show(),$(".help-icon").mouseover(function(){}).mouseout(function(){}),$(".help-icon").first().css("color","grey")):($(".modal").hide(),$(".help-icon").first().css("color","black"),$(".help-icon").mouseover(function(){$(this).css("color","grey")}).mouseout(function(){$(this).css("color","black")}))}static show(){return this.setVisible(!0)}static hide(){return this.setVisible(!1)}}class Point{constructor(order,circle){this.order=order,this.circle=circle,this.xFunc=(()=>Math.sin(this.angle)*this.circle.r),this.yFunc=(()=>-Math.cos(this.angle)*this.circle.r),this.state=-1,this.text=null,this.angle=this.order/this.circle.n*2*Math.PI,this.x=this.xFunc(),this.y=this.yFunc(),this.r=this.circle.pointRadius,this.elem=this.circle.svg.circle(this.x,this.y,this.r,this.r),this.group=null,this.init()}init(){this.resetStyle(),void 0!==this.circle.options[0].text?(this.text=this.circle.svg.text(this.x,this.y,""),this.text.attr({y:this.getTextY()}),this.text.attr({"text-anchor":"middle"}),this.group=this.circle.svg.group(this.elem,this.text)):this.group=this.elem,this._visible=!0,this.initClickEvents(this.group)}get visible(){return this._visible}set visible(bool){this._visible=bool,bool?(Utils.show(this.group),Utils.show(this.elem)):(Utils.hide(this.group),Utils.hide(this.elem))}getTextY(){let actualText=this.text.node.textContent;this.text.attr({text:"A"});let textY=this.y+this.text.getBBox().height/4;return this.text.attr({text:actualText}),textY}initClickEvents(elem){elem.hover(function(){this.circle.app.touched||this.elem.attr({strokeWidth:this.circle.pointStrokeWidthHover})}.bind(this),function(){this.elem.attr({strokeWidth:this.circle.pointStrokeWidth})}.bind(this)),elem.click(evt=>{this.circle.app.touched||this.onClick(evt)}),elem.touchstart(evt=>{this.circle.app.touched=!0,this.onClick(evt)})}onClick(evt){let step=evt.metaKey?-1:1,tempState=this.state+step;if(tempState<-1?this.state=this.circle.options.length-1:tempState>this.circle.options.length-1?this.state=-1:this.state=tempState,this.color=-1===this.state?this.circle.pointFillColor:this.circle.options[this.state].color,void 0!==this.circle.options[0].text){let text=-1!==this.state?this.circle.options[this.state].text:"";this.text.attr({text:text})}this.elem.attr({fill:this.color}),this.circle.binary&&this.circle.updateBinary()}resetStyle(){this.elem.attr({fill:this.circle.pointFillColor,stroke:this.circle.pointStroke,strokeWidth:this.circle.pointStrokeWidth})}reset(){this.state=-1,this.text&&this.text.attr({text:""}),this.resetStyle()}}Snap.plugin(function(Snap,Element,Paper,global){Paper.prototype.hline=function(y,x1,x2){return this.line(x1,y,x2,y)},Paper.prototype.vline=function(x,y1,y2){return this.line(x,y1,x,y2)},Paper.prototype.rectc=function(cx,cy,w,h){return this.rect(cx-w/2,cy-h/2,w,h)},Paper.prototype.square=function(x0,y0,s){return this.rect(x0,y0,s,s)},Paper.prototype.squarec=function(cx,cy,s){return this.square(cx-s/2,cy-s/2,s)}});class Utils{static setVisible(elem,bool){let visibility=bool?"visible":"hidden";elem.attr({visibility:visibility})}static hide(elem){return this.setVisible(elem,!1)}static show(elem){return this.setVisible(elem,!0)}static zeros(rows,cols){let matrix=new Array(rows);for(let i=0;i<rows;i++){matrix[i]=[];for(let j=0;j<cols;j++)matrix[i][j]=0}return matrix}static isPortrait(){return $("#svg").height()<=$("#svg").width()}static isLandscape(){return!this.isPortrait()}static hideLoader(){$("#loader").hide(),$("#wrapper").css("display","flex")}static getBodyFontSize(){return parseInt($("body").css("font-size"),10)}}window.addEventListener("load",function(){Utils.hideLoader();const em=Utils.getBodyFontSize(),rectSize=2.4*em,app=new App({paths:App.defaults.paths.all(),spatial:!1,debug:!1,pointRadius:1.8*em,paddingFactor:1}),url=window.location.pathname,s1="/S1/"===url,s3="/S3/"===url;let params;params=s1?{xFunc:function(){return app.width/2},yFunc:function(){return app.height/2},rFunc:function(){return Math.min(250,Math.min(app.width,app.height)/2-app.padding-app.pointRadius)},options:Circle.defaults.options.percussive,sequencer:!1}:{xFunc:Circle.defaults.xFunc1,yFunc:Circle.defaults.yFunc1,options:Circle.defaults.options.percussive,shake:!0,sequencer:s3,sequencerRectSize:rectSize},app.addCircle(params),s1||app.addCircle({xFunc:Circle.defaults.xFunc2,yFunc:Circle.defaults.yFunc2,options:Circle.defaults.options.notes,shake:!0,sequencer:s3,sequencerRectSize:rectSize,circleBackgroundColor:Colors.lightgreen})});
